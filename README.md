# Tsdbperf

An async [Rust][rust-lang] application that inserts simulated
 time-series data into a [TimescaleDB][timescale-db] instance and
 reports ingestion rate statistics.

[rust-lang]: https://www.rust-lang.org
[timescale-db]: https://www.timescale.com/

## Overview

An example of time-series data is a stream of measurements coming from
a group of devices. A measurement has a timestamp, a device
identifier, and a number of metrics that are generated by that device.

The following command:

```bash
$ time ./tsdbperf --workers 8 --devices 10 --measurements 100000 --metrics 10
[2020-10-31T14:33:47Z INFO  tsdbperf] Number of workers:       8
[2020-10-31T14:33:47Z INFO  tsdbperf] Devices per worker:      10
[2020-10-31T14:33:47Z INFO  tsdbperf] Metrics per device:      10
[2020-10-31T14:33:47Z INFO  tsdbperf] Measurements per device: 100000
[2020-10-31T14:33:59Z INFO  tsdbperf] Wrote   8000000 measurements in 12.59 seconds
[2020-10-31T14:33:59Z INFO  tsdbperf] Wrote    635677 measurements per second
[2020-10-31T14:33:59Z INFO  tsdbperf] Wrote   6356774 metrics per second

real    0m12.791s
user    0m5.981s
sys     0m1.845s
```

runs 8 parallel workers, for each worker it generates data for 10
devices and for each device it generates 100,000 measurements each
having 10 metrics. On my laptop, that has 12 CPUs, it took 12.59
seconds to insert 8,000,000 measurements.

Now that we have generated the data we can run queries to inspect it:

```sql
postgres@localhost> select count(distinct(device_id)) from measurement
+---------+
| count   |
|---------|
| 80      |
+---------+

postgres@localhost> select count(*) from measurement
+---------+
| count   |
|---------|
| 8000000 |
+---------+

postgres@localhost> select min(time), max(time) from measurement
+-------------------------------+-------------------------------+
| min                           | max                           |
|-------------------------------+-------------------------------|
| 2020-10-30 10:47:08.315839+00 | 2020-10-31 14:33:47.316317+00 |
+-------------------------------+-------------------------------+
```

The hypertable chunk interval is 1 day, with the data spanning 2 days
we should have 2 chunks:

```sql
postgres@localhost> select chunk_table, table_size
 from chunk_relation_size_pretty('measurement')
+-----------------------------------------+--------------+
| chunk_table                             | table_size   |
|-----------------------------------------+--------------|
| _timescaledb_internal._hyper_5_9_chunk  | 458 MB       |
| _timescaledb_internal._hyper_5_10_chunk | 504 MB       |
+-----------------------------------------+--------------+
```

With 10 metrics per measurement the schema looks like:

```sql
postgres@localhost> \d measurement
+-----------+--------------------------+-------------+
| Column    | Type                     | Modifiers   |
|-----------+--------------------------+-------------|
| time      | timestamp with time zone |  not null   |
| device_id | integer                  |             |
| m1        | double precision         |             |
| m2        | double precision         |             |
| m3        | double precision         |             |
| m4        | double precision         |             |
| m5        | double precision         |             |
| m6        | double precision         |             |
| m7        | double precision         |             |
| m8        | double precision         |             |
| m9        | double precision         |             |
| m10       | double precision         |             |
+-----------+--------------------------+-------------+
Indexes:
    "measurement_device_id_time_idx" btree (device_id, "time" DESC)
    "measurement_time_idx" btree ("time" DESC)
Triggers:
    ts_insert_blocker BEFORE INSERT ON measurement FOR EACH ROW EXECUTE FUNC...
Number of child tables: 2 (Use \d+ to list them.)
```

## Run with docker-compose

If you have docker-compose installed the easiest way to run tsdbperf
is to download this [compose file][tsdbperf-compose], run a local
instance of TimescaleDB:

```bash
$ docker-compose up -d timescale
Creating network "docker_default" with the default driver
Creating docker_timescale_1 ... done
```

then run tsdbperf with `docker-compose run`:

```bash
$ docker-compose run tsdbperf
[2020-10-31T14:44:34Z INFO  tokio_postgres::connection] NOTICE: table "measurem...
[2020-10-31T14:44:34Z INFO  tsdbperf] Number of workers:       8
[2020-10-31T14:44:34Z INFO  tsdbperf] Devices per worker:      10
[2020-10-31T14:44:34Z INFO  tsdbperf] Metrics per device:      10
[2020-10-31T14:44:34Z INFO  tsdbperf] Measurements per device: 100000
[2020-10-31T14:44:46Z INFO  tsdbperf] Wrote   8000000 measurements in 12.83 seconds
[2020-10-31T14:44:46Z INFO  tsdbperf] Wrote    623490 measurements per second
[2020-10-31T14:44:46Z INFO  tsdbperf] Wrote   6234900 metrics per second
```

To shutdown TimescaleDB and clean up containers run:

```bash
$ docker-compose down -v
Stopping docker_timescale_1 ... done
Removing docker_tsdbperf_run_5614aecce5d9 ... done
Removing docker_timescale_1               ... done
Removing network docker_default
```

To change the number of workers, or devices, edit their values in the
compose file and then rerun, the `--help` option shows a summary of
all options:

```bash
$ docker run --rm vincev/tsdbperf:v0.1.0 --help
tsdbperf 0.1.0

USAGE:
    tsdbperf [FLAGS] [OPTIONS]

FLAGS:
        --dry-run    Do not write data to the DB
    -h, --help       Prints help information
    -V, --version    Prints version information

OPTIONS:
        --batch-size <batch-size>            Number of measurements per insert [default: 10000]
        --chunk-interval <chunk-interval>    Hypertable chunk interval in seconds [default: 86400]
        --db-host <db-host>                  Database host [default: localhost]
        --db-name <db-name>                  Database name [default: postgres]
        --db-password <db-password>          Database password [default: postgres]
        --db-user <db-user>                  Database user [default: postgres]
        --devices <num-devices>              Number of devices per worker [default: 10]
        --measurements <num-measurements>    Number of measurements per device [default: 100000]
        --metrics <num-metrics>              Number of metrics per device [default: 10]
        --workers <num-workers>              Number of parallel workers [default: number of CPUs]
```

[tsdbperf-compose]: https://github.com/vincev/tsdbperf/blob/master/docker/docker-compose.yml
